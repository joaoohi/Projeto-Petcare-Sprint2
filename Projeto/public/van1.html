<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Presença e Temperatura</title>
    <link rel="stylesheet" href="./css/vans.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="chama()">
    <div class="container">
        <aside>
            <div class="img-aside">
                <img src="./assets/imgs/frizzaimg.jpg" alt="">
            </div><br>
            <div class="bemvindo">
                Bem-Vindo, Frizza!
            </div><br><br>
            <div class="buttonsmeio">
                <button onclick="window.location.href='dashboardGu.html'">VOLTAR</button><br><br>
                <button onclick="window.location.href='index.html'">HOME</button><br><br>
                <button onclick="window.location.href='login.html'">SAIR</button>
            </div>
        </aside>
       
        <!-- <div class="metricas-container">
            <div class="metricas1">Métrica 1</div>
            <div class="metricas2">Métrica 2</div>
            <div class="metricas3">Métrica 3</div>
        </div> -->
        <section>
            <div>
                <canvas id="myChart2" width="400" height="200" style="margin-top: 20px;"></canvas>
            </div>
            <div>
                <canvas id="myChart1" width="400" height="200"></canvas>
            </div>
            <!-- <div>
                <canvas id="myChart3" width="400" height="200"></canvas>
            </div> -->
        </section>
    </div>
    <script data-jsd-embedded data-key="367ff213-fca9-4235-8439-0194cd16ca8f" data-base-url="https://jsd-widget.atlassian.com" src="https://jsd-widget.atlassian.com/assets/embed.js"></script>
</body>

</html>

<script>

// const ctx3 = document.getElementById('myChart3').getContext('2d');
//     const myChart3 = new Chart(ctx3, {
//         type: 'bar',
//         data: {
//             labels: [],
//             datasets: [{
//                 label: 'Temperatura na Van (°C)',
//                 data: [],
//                 borderWidth: 2,
//                 fill: false,
//                 pointBackgroundColor: [], // Cores dos pontos
//                 lineTension: 0.2
//             }]
//         },
//         options: {
//             animation: {
//                 duration: 1000,
//                 easing: 'linear'
//             },
//             scales: {
//                 x: {
//                     title: {
//                         display: true,
//                         text: 'Tempo',
//                         color: 'black'
//                     },
//                     type: 'category',
//                     ticks: {
//                         color: 'black'
//                     }
//                 },
//                 y: {
//                     min: 16,
//                     max: 28,
//                     ticks: {
//                         stepSize: 2,
//                         callback: function (value) {
//                             return `${value}°C`;
//                         },
//                         color: 'black'
//                     },
//                     title: {
//                         display: true,
//                         text: 'Temperatura (°C)',
//                         color: 'black'
//                     }
//                 }
//             }
//         }
//     });
    const ctx2 = document.getElementById('myChart2').getContext('2d');
    const myChart2 = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura na Van (°C)',
                data: [],
                borderWidth: 2,
                fill: false,
                pointBackgroundColor: [], // Cores dos pontos
                lineTension: 0.2
            }]
        },
        options: {
            animation: {
                duration: 1000,
                easing: 'linear'
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Tempo',
                        color: 'black'
                    },
                    type: 'category',
                    ticks: {
                        color: 'black'
                    }
                },
                y: {
                    min: 16,
                    max: 28,
                    ticks: {
                        stepSize: 2,
                        callback: function (value) {
                            return `${value}°C`;
                        },
                        color: 'black'
                    },
                    title: {
                        display: true,
                        text: 'Temperatura (°C)',
                        color: 'black'
                    }
                }
            }
        }
    });
   
    const ctx1 = document.getElementById('myChart1').getContext('2d');
    const myChart1 = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: [], // Labels atualizadas em tempo real
            datasets: [{
                label: 'Presença do Pet na Van',
                data: [], // Dados atualizados em tempo real
                backgroundColor: 'rgba(106, 245, 237, 0.2)', // Fundo
                borderColor: 'rgba(106, 245, 237, 1)', // Cor da linha
                borderWidth: 2,
                fill: true,
                lineTension: 0.2 // Suavidade da linha
            }]
        },

        options: {
            animation: {
                duration: 1000,
                easing: 'linear'
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Tempo',
                        color: 'black'
                    },
                    type: 'category',
                    ticks: {
                        color: 'black'
                    }
                },
                y: {
                    min: 0,
                    max: 1,
                    ticks: {
                        stepSize: 1,
                        callback: function (value) {
                            return value === 1 ? 'Presente' : 'Ausente';
                        },
                        color: 'black'
                    },
                    title: {
                        display: true,
                        text: 'Status',
                        color: 'black'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.raw === 1 ? 'Presente' : 'Ausente';
                        }
                    }
                }
            }
        }
    });


    function chama() {
        buscarUltimasMedidasBloqueio()
        buscarUltimasMedidasTemperatura()
    }

    function buscarUltimasMedidasBloqueio() {
        var idEmpresa = sessionStorage.ID_USUARIO
        fetch(`/medida/presenca/${idEmpresa}`, { cache: "no-store" })
            .then(function (response) {
                if (response.status === 200) {
                    response.json().then((json) => {
                        console.log(`Dados recebidos: ${JSON.stringify(json)}`);
                        plotarGraficoBloqueio(json);
                    })
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.log(`Erro na obtenção dos dados p/ gráfico:`, error);
            });
    }

    function buscarUltimasMedidasTemperatura() {
        var idEmpresa = sessionStorage.ID_USUARIO
        fetch(`/medida/temperatura/${idEmpresa}`, { cache: "no-store" })
            .then(function (response) {
                if (response.status == 200) {
                    response.json().then((json) => {
                        console.log(`Dados recebidos: ${JSON.stringify(json)}`);
                        plotarGraficoTemperatura(json);
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.log(`Erro na obtenção dos dados p/ gráfico:`, erro);
            });

    }

    // Configuração do gráfico de presença  
    function plotarGraficoBloqueio(resposta) {
        console.log('cheguei')
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            myChart1.data.datasets[0].data.push(registro.sensor_digital);
            myChart1.data.labels.push(registro.momento_grafico)
        }

        myChart1.update();
    };

    function plotarGraficoTemperatura(resposta) {

        // Configuração do gráfico de temperatura
        // alert(JSON.stringify(resposta));
        //resolvendo
        //resolvendo
        console.log('cheguei')
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            myChart2.data.datasets[0].data.push(registro.sensor_analogico);
            myChart2.data.labels.push(registro.momento_grafico)
        }

        myChart2.update();

    }



    function atualizarGraficoTemperatura() {
        fetch(`/medida/temperaturaUltimas`, { cache: "no-store" })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (respostaJSON) {
                        console.log(`Dados recebidos: ${JSON.stringify(respostaJSON)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(myChart2.data);

                        myChart1.data.datasets[0].data = [];

                        for (let i = 0; i < respostaJSON.length; i++) {
                            myChart2.data.datasets[0].data.push(respostaJSON[i].quantidade);
                        }

                        myChart2.update();
                    });
                } else {
                    console.log("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.log(`Erro na obtenção dos dados p/ gráfico:`, error);
            });
    }

    function atualizarGraficoPresenca() {
        fetch(`/medida/presencaUltimas`, { cache: "no-store" })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (respostaJSON) {
                        console.log(`Dados recebidos: ${JSON.stringify(respostaJSON)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(myChart1.data);

                        myChart1.data.datasets[0].data.splice(0, myChart1.data.datasets[0].data.length);

                        for (let i = 0; i < respostaJSON.length; i++) {
                            myChart1.data.datasets[0].data.push(respostaJSON[i].quantidade);
                        }

                        myChart1.update();
                    });
                } else {
                    console.log("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.log(`Erro na obtenção dos dados p/ gráfico:`, error);
            });
    }

</script>